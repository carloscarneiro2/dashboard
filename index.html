<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard RO ‚Äì Reclama√ß√µes</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f8; margin:0; padding:20px }
    .card { background:#fff; padding:18px; border-radius:10px; margin:10px; box-shadow:0 0 8px #0001;
            display:inline-block; min-width:260px; text-align:center }
    .card h3 { margin:0; font-size:1.1rem; color:#222 }
    .card span { font-size:1.8rem; font-weight:bold; color:#1a73e8 }
    .section { background:#fff; border-radius:10px; padding:10px; margin-top:18px; box-shadow:0 0 8px #0001 }
    canvas { width:100% !important; max-height:360px }
    table { width:100%; border-collapse:collapse; margin-top:10px }
    th, td { padding:8px; border:1px solid #ccc; font-size:.9rem }
    th { background:#eafbff }
    .filter-btn { background:#1a73e8; color:#fff; border:none; padding:7px 14px;
                  margin:5px; border-radius:6px; cursor:pointer }
  </style>
</head>

<body>

<h1>Dashboard RO ‚Äì Reclama√ß√µes</h1>
<p>Dados carregados automaticamente do arquivo: <b>dados.csv</b></p>

<!-- Indicadores -->
<div style="display:flex;flex-wrap:wrap">
  <div class="card"><h3>Total de ROs</h3><span id="totalROs">0</span></div>
  <div class="card"><h3>Tons Reclamados</h3><span id="totalTon">0</span></div>
  <div class="card"><h3>√Årea Reclamada (m¬≤)</h3><span id="totalM2">0</span></div>
  <div class="card"><h3>% com FP Realizado</h3><span id="percentFP">0%</span></div>
</div>

<!-- Filtros por Status -->
<div class="section">
  <button class="filter-btn" onclick="filtrarTabela('Todas')">Todas</button>
  <button class="filter-btn" onclick="filtrarTabela('')">Sem Situa√ß√£o</button>
  <span id="statusBtns"></span>
</div>

<!-- Gr√°ficos -->
<div style="display:flex; gap:15px; flex-wrap:wrap">
  <div class="section" style="flex:1">
    <h3>ROs por Motivo</h3>
    <canvas id="motivoChart"></canvas>
  </div>
  <div class="section" style="flex:1">
    <h3>ROs por Situa√ß√£o Atual</h3>
    <canvas id="statusChart"></canvas>
  </div>
</div>

<!-- Tabela -->
<div class="section">
  <h3>Detalhamento das Reclama√ß√µes</h3>
  <table id="tabelaRO">
    <thead>
      <tr>
        <th>N¬∫ RO</th><th>Cliente</th><th>Data</th><th>Motivo</th>
        <th>Situa√ß√£o Atual</th><th>Qtd FP</th><th>√öltimo FP</th><th>Tons</th><th>m¬≤</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<script>
let dados = [];
let tabela = document.querySelector("#tabelaRO tbody");
let motivoChart, statusChart;

/* üßπ REMOVE BOM INVIS√çVEL */
function limparBOM(str){
  return str.replace("\ufeff","").trim();
}

/* üì• CARREGA CSV */
fetch("dados.csv")
  .then(res => res.text())
  .then(texto => processarCSV(texto));

function processarCSV(csv){
  const linhas = csv.split("\n").filter(l => l.trim() !== "");
  const headers = limparBOM(linhas[0]).split(",").map(h=>limparBOM(h));

  linhas.slice(1).forEach(linha =>{
    const col = linha.split(",");
    if(col.length < 5) return;
    let obj = {};
    headers.forEach((h,i)=> obj[h] = limparBOM(col[i] || ""));
    dados.push(obj);
  });

  atualizarDashboard(dados);
}

/* üìä ATUALIZA M√âTRICAS + GR√ÅFICOS + TABELA */
function atualizarDashboard(base){
  document.querySelector("#totalROs").innerText = base.length;
  document.querySelector("#totalTon").innerText = soma(base,"Reclamado Ton");
  document.querySelector("#totalM2").innerText = soma(base,"Reclamado M2");
  document.querySelector("#percentFP").innerText = 
      parseInt((base.filter(r=>parseInt(r["Qtd de FP realizado"])>0).length / base.length)*100) + "%";

  preencherTabela(base);
  desenharGraficos(base);
}

/* ‚ûï SOMA NUM√âRICA */
function soma(arr,campo){
  return arr.reduce((t,v)=> t + (parseFloat(v[campo]) || 0),0).toFixed(1);
}

/* üìã MONTAR TABELA */
function preencherTabela(base){
  tabela.innerHTML = "";
  base.forEach(r=>{
    tabela.innerHTML += `
      <tr>
        <td>${r["N√∫mero RO"]||""}</td>
        <td>${r.Cliente||""}</td>
        <td>${r["Data Abertura RO"]||""}</td>
        <td>${r.Motivo||""}</td>
        <td>${r["Situa√ß√£o atual do RO"]||""}</td>
        <td>${r["Qtd de FP realizado"]||""}</td>
        <td>${r["√öltimo FP realizado"]||""}</td>
        <td>${r["Reclamado Ton"]||""}</td>
        <td>${r["Reclamado M2"]||""}</td>
      </tr>`;
  });
}

/* üéØ Gr√°ficos */
function desenharGraficos(base){
  const motivos = {};
  const status = {};

  base.forEach(r=>{
    motivos[r.Motivo] = (motivos[r.Motivo] || 0) +1;
    status[r["Situa√ß√£o atual do RO"]] = (status[r["Situa√ß√£o atual do RO"]] ||1);
  });

  atualizarGrafico("motivoChart", motivoChart,
    Object.keys(motivos), Object.values(motivos),
    "ROs por Motivo", "#4aa3ff");

  atualizarGrafico("statusChart", statusChart,
    Object.keys(status), Object.values(status),
    "ROs por Situa√ß√£o Atual", "#ffc85b", true);
}

function atualizarGrafico(id, ref, labels, data, titulo, cor, pizza){
  if(ref) ref.destroy();
  ref = new Chart(document.getElementById(id), {
    type: pizza ? "doughnut":"bar",
    data: { labels,
      datasets:[{ data, backgroundColor: ["#4aa3ff","#ff7597","#ffc85b","#68d391","#9d4edd"] }]
    },
    options:{ responsive:true }
  });

  if(id==="statusChart") ref.canvas.onclick = evt => {
    const ponto = ref.getElementsAtEventForMode(evt,"nearest",{intersect:true},false)[0];
    if(!ponto) return;
    filtrarTabela(labels[ponto.index]);
  };

  if(id==="motivoChart") motivoChart = ref; else statusChart = ref;
}

/* üîç FILTRO */
function filtrarTabela(valor){
  let filtrado = valor==="Todas" ? dados :
    dados.filter(r => (r["Situa√ß√£o atual do RO"]||"") === valor );
  atualizarDashboard(filtrado);
}
</script>

</body>
</html>
